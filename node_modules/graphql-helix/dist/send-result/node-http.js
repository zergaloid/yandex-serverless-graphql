"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.sendResult = exports.sendPushResult = exports.sendMultipartResponseResult = exports.sendResponseResult = void 0;
const errors_1 = require("../errors");
const DEFAULT_TRANSFORM_RESULT_FN = (result) => result;
async function sendResponseResult(responseResult, rawResponse, transformResult = DEFAULT_TRANSFORM_RESULT_FN) {
    for (const { name, value } of responseResult.headers) {
        rawResponse.setHeader(name, value);
    }
    rawResponse.writeHead(responseResult.status, {
        "content-type": "application/json",
    });
    rawResponse.end(JSON.stringify(transformResult(responseResult.payload)));
}
exports.sendResponseResult = sendResponseResult;
async function sendMultipartResponseResult(multipartResult, rawResponse, transformResult = DEFAULT_TRANSFORM_RESULT_FN) {
    rawResponse.writeHead(200, {
        // prettier-ignore
        "Connection": "keep-alive",
        "Content-Type": 'multipart/mixed; boundary="-"',
        "Transfer-Encoding": "chunked",
    });
    rawResponse.on("close", () => {
        multipartResult.unsubscribe();
    });
    // @ts-expect-error - Different Signature between ServerResponse and Http2ServerResponse but still compatible.
    rawResponse.write("---");
    await multipartResult.subscribe((result) => {
        const chunk = Buffer.from(JSON.stringify(transformResult(result)), "utf8");
        const data = ["", "Content-Type: application/json; charset=utf-8", "Content-Length: " + String(chunk.length), "", chunk];
        if (result.hasNext) {
            data.push("---");
        }
        // @ts-expect-error - Different Signature between ServerResponse and Http2ServerResponse but still compatible.
        rawResponse.write(data.join("\r\n"));
    });
    // @ts-expect-error - Different Signature between ServerResponse and Http2ServerResponse but still compatible.
    rawResponse.write("\r\n-----\r\n");
    rawResponse.end();
}
exports.sendMultipartResponseResult = sendMultipartResponseResult;
async function sendPushResult(pushResult, rawResponse, transformResult = DEFAULT_TRANSFORM_RESULT_FN) {
    rawResponse.writeHead(200, {
        "Content-Type": "text/event-stream",
        // prettier-ignore
        "Connection": "keep-alive",
        "Cache-Control": "no-cache",
    });
    rawResponse.on("close", () => {
        pushResult.unsubscribe();
    });
    await pushResult.subscribe((result) => {
        // @ts-expect-error - Different Signature between ServerResponse and Http2ServerResponse but still compatible.
        rawResponse.write(`data: ${JSON.stringify(transformResult(result))}\n\n`);
    });
}
exports.sendPushResult = sendPushResult;
async function sendResult(result, rawResponse, transformResult = DEFAULT_TRANSFORM_RESULT_FN) {
    switch (result.type) {
        case "RESPONSE":
            return sendResponseResult(result, rawResponse, transformResult);
        case "MULTIPART_RESPONSE":
            return sendMultipartResponseResult(result, rawResponse, transformResult);
        case "PUSH":
            return sendPushResult(result, rawResponse, transformResult);
        default:
            throw new errors_1.HttpError(500, "Cannot process result.");
    }
}
exports.sendResult = sendResult;
